name: Merge Verification

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  checks: write
  actions: read
  pull-requests: read

jobs:
  verify:
    name: merge-verification
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Wait for required workflows and create merge-verification check
        uses: actions/github-script@v7
        with:
          script: |
            const requiredWorkflows = [
              'PHPUnit Tests',
              'PHPStan Static Analysis'
            ];

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const ref = context.payload.pull_request.head.ref;

            // Create a pending check run for visibility
            const check = await github.rest.checks.create({
              owner,
              repo,
              name: 'merge-verification',
              head_sha: context.payload.pull_request.head.sha,
              status: 'in_progress'
            });

            const maxWaitMs = 5 * 60 * 1000; // 5 minutes
            const pollIntervalMs = 8000; // 8s
            const start = Date.now();

            async function workflowSucceeded(workflowName) {
              // find latest completed run for this workflow on the PR branch
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                workflow_id: undefined,
                branch: ref,
                event: 'pull_request',
                per_page: 10
              });

              // filter runs by workflow name
              const filtered = runs.data.workflow_runs.filter(r => r.name === workflowName && (r.head_branch === ref || r.head_sha === context.payload.pull_request.head.sha));
              if (filtered.length === 0) return null;
              // pick latest
              const latest = filtered[0];
              if (latest.status !== 'completed') return 'in_progress';
              if (latest.conclusion === 'success') return 'success';
              return 'failure';
            }

            while (Date.now() - start < maxWaitMs) {
              let allSuccess = true;
              let anyInProgress = false;
              for (const wf of requiredWorkflows) {
                const res = await workflowSucceeded(wf);
                if (res === null) {
                  // Not run yet
                  anyInProgress = true;
                  allSuccess = false;
                  break;
                }
                if (res === 'in_progress') {
                  anyInProgress = true;
                  allSuccess = false;
                }
                if (res === 'failure') {
                  allSuccess = false;
                  // set check to failure and exit early
                  await github.rest.checks.update({
                    owner,
                    repo,
                    check_run_id: check.data.id,
                    status: 'completed',
                    conclusion: 'failure',
                    output: {
                      title: 'Merge verification failed',
                      summary: `Required workflow ${wf} failed`,
                    }
                  });
                  core.setFailed(`Required workflow ${wf} failed`);
                  return;
                }
              }

              if (allSuccess) {
                await github.rest.checks.update({
                  owner,
                  repo,
                  check_run_id: check.data.id,
                  status: 'completed',
                  conclusion: 'success',
                  output: {
                    title: 'Merge verification passed',
                    summary: 'All required workflows passed.'
                  }
                });
                return;
              }

              // Still waiting
              await new Promise(r => setTimeout(r, pollIntervalMs));
            }

            // Timeout
            await github.rest.checks.update({
              owner,
              repo,
              check_run_id: check.data.id,
              status: 'completed',
              conclusion: 'failure',
              output: {
                title: 'Merge verification timed out',
                summary: `Timed out waiting for required workflows to complete (waited ${maxWaitMs/1000}s)`
              }
            });
            core.setFailed('Merge verification timed out waiting for required workflows');
